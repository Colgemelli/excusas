<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Sistema de Excusas y Permisos</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Supabase v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Estilos espec√≠ficos para diagn√≥stico */
        .diagnostic-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: monospace;
        }
        
        .diagnostic-header {
            background: #1e293b;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .diagnostic-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .diagnostic-section h3 {
            background: #f1f5f9;
            margin: 0;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .diagnostic-content {
            padding: 20px;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .log-info { background: #e0f2fe; color: #0277bd; }
        .log-success { background: #e8f5e8; color: #2e7d32; }
        .log-warning { background: #fff3e0; color: #f57c00; }
        .log-error { background: #ffebee; color: #d32f2f; }
        
        .test-button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #1565c0;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-running { background: #fff3e0; color: #f57c00; }
        .status-success { background: #e8f5e8; color: #2e7d32; }
        .status-error { background: #ffebee; color: #d32f2f; }
        
        #console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <div class="diagnostic-header">
            <h1>üîç Sistema de Diagn√≥stico</h1>
            <p>Diagnosticando conexi√≥n con Supabase...</p>
            <div class="status-indicator status-running" id="main-status">üîÑ Ejecutando diagn√≥stico...</div>
        </div>

        <div class="diagnostic-section">
            <h3>üìä Estado de las Pruebas</h3>
            <div class="diagnostic-content">
                <div id="test-results">
                    <div class="log-entry log-info">Iniciando diagn√≥stico del sistema...</div>
                </div>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>üß™ Pruebas Manuales</h3>
            <div class="diagnostic-content">
                <button class="test-button" onclick="testSupabaseConnection()">
                    üîó Probar Conexi√≥n Supabase
                </button>
                <button class="test-button" onclick="testDatabaseStructure()">
                    üèóÔ∏è Verificar Estructura BD
                </button>
                <button class="test-button" onclick="testDataInsertion()">
                    üíæ Probar Inserci√≥n
                </button>
                <button class="test-button" onclick="testFormulario()">
                    üìù Probar Formulario
                </button>
                <button class="test-button" onclick="clearLogs()">
                    üóëÔ∏è Limpiar Logs
                </button>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>üì∫ Consola en Tiempo Real</h3>
            <div class="diagnostic-content">
                <div id="console-output">Esperando logs...\n</div>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>üéØ Prueba R√°pida de Formulario</h3>
            <div class="diagnostic-content">
                <form id="test-form" style="display: grid; gap: 10px; max-width: 400px;">
                    <input type="text" placeholder="Nombre del estudiante" id="test-nombre" value="Estudiante Prueba">
                    <select id="test-grado">
                        <option value="">Seleccionar grado...</option>
                        <option value="5¬∞">5¬∞</option>
                        <option value="6¬∞">6¬∞</option>
                        <option value="7¬∞">7¬∞</option>
                    </select>
                    <textarea placeholder="Motivo de la excusa" id="test-motivo">Prueba de funcionamiento del sistema</textarea>
                    <input type="text" placeholder="Nombre del acudiente" id="test-acudiente" value="Acudiente Prueba">
                    <input type="email" placeholder="Email del acudiente" id="test-email" value="prueba@test.com">
                    <input type="tel" placeholder="Tel√©fono del acudiente" id="test-telefono" value="1234567890">
                    <button type="submit" class="test-button">üì§ Enviar Solicitud de Prueba</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Configuraci√≥n
        window.SUPABASE_CONFIG = {
            url: 'https://zkbnpjmtwkhcvqizpmhj.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprYm5wam10d2toY3ZxaXpwbWhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNTQyNDksImV4cCI6MjA2NjczMDI0OX0.McMyTT8-Myp6L0nIjTN4chedAPunB0dwymQKhiNp6uI'
        };

        let supabaseClient = null;
        let logCount = 0;

        // Override console para capturar logs
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        function addToConsole(message, type = 'log') {
            const consoleOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Tambi√©n mostrar en consola original
            originalConsole[type](message);
        }

        console.log = (message) => addToConsole(message, 'log');
        console.error = (message) => addToConsole(message, 'error');
        console.warn = (message) => addToConsole(message, 'warn');

        function addTestResult(message, status = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${status}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateMainStatus(message, status = 'running') {
            const statusDiv = document.getElementById('main-status');
            statusDiv.textContent = message;
            statusDiv.className = `status-indicator status-${status}`;
        }

        async function initSupabase() {
            try {
                addTestResult('üîÑ Verificando carga de Supabase...', 'info');
                
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Librer√≠a Supabase no est√° cargada');
                }
                
                addTestResult('‚úÖ Librer√≠a Supabase cargada correctamente', 'success');
                
                supabaseClient = window.supabase.createClient(
                    window.SUPABASE_CONFIG.url, 
                    window.SUPABASE_CONFIG.key
                );
                
                addTestResult('‚úÖ Cliente Supabase inicializado', 'success');
                console.log('Supabase inicializado correctamente');
                
                return true;
            } catch (error) {
                addTestResult(`‚ùå Error inicializando Supabase: ${error.message}`, 'error');
                console.error('Error:', error);
                return false;
            }
        }

        async function testSupabaseConnection() {
            try {
                addTestResult('üîÑ Probando conexi√≥n a Supabase...', 'info');
                
                if (!supabaseClient) {
                    const initialized = await initSupabase();
                    if (!initialized) return;
                }

                const { data, error } = await supabaseClient
                    .from('grados')
                    .select('*')
                    .limit(1);

                if (error) {
                    throw new Error(`Error de conexi√≥n: ${error.message}`);
                }

                addTestResult(`‚úÖ Conexi√≥n exitosa - Encontrados ${data ? data.length : 0} registros en tabla grados`, 'success');
                console.log('Datos de prueba:', data);
                
            } catch (error) {
                addTestResult(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                console.error('Error de conexi√≥n:', error);
            }
        }

        async function testDatabaseStructure() {
            try {
                addTestResult('üîÑ Verificando estructura de base de datos...', 'info');
                
                if (!supabaseClient) {
                    const initialized = await initSupabase();
                    if (!initialized) return;
                }

                const tables = [
                    'estados_solicitud',
                    'tipos_solicitud',
                    'tipos_usuario',
                    'grados',
                    'usuarios',
                    'estudiantes',
                    'solicitudes'
                ];

                for (const table of tables) {
                    try {
                        const { data, error } = await supabaseClient
                            .from(table)
                            .select('*')
                            .limit(1);

                        if (error) {
                            addTestResult(`‚ùå Error en tabla ${table}: ${error.message}`, 'error');
                        } else {
                            addTestResult(`‚úÖ Tabla ${table} accesible`, 'success');
                        }
                    } catch (err) {
                        addTestResult(`‚ùå Error verificando tabla ${table}: ${err.message}`, 'error');
                    }
                }

                addTestResult('üéØ Verificaci√≥n de estructura completada', 'info');
                
            } catch (error) {
                addTestResult(`‚ùå Error verificando estructura: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        }

        async function testDataInsertion() {
            try {
                addTestResult('üîÑ Probando inserci√≥n de datos...', 'info');
                
                if (!supabaseClient) {
                    const initialized = await initSupabase();
                    if (!initialized) return;
                }

                // Obtener IDs necesarios
                const { data: tipoData } = await supabaseClient
                    .from('tipos_solicitud')
                    .select('id')
                    .eq('nombre', 'excusa')
                    .single();

                const { data: estadoData } = await supabaseClient
                    .from('estados_solicitud')
                    .select('id')
                    .eq('nombre', 'pendiente')
                    .single();

                const { data: gradoData } = await supabaseClient
                    .from('grados')
                    .select('id')
                    .eq('nombre', '5¬∞')
                    .single();

                if (!tipoData || !estadoData || !gradoData) {
                    throw new Error('Datos b√°sicos faltantes en las tablas');
                }

                addTestResult('‚úÖ Datos b√°sicos encontrados', 'success');

                // Insertar datos de prueba
                const testData = {
                    radicado: `TEST-${Date.now()}`,
                    tipo_solicitud_id: tipoData.id,
                    estado_actual_id: estadoData.id,
                    nombre_estudiante: 'Estudiante Prueba Diagn√≥stico',
                    grado_id: gradoData.id,
                    motivo: 'Prueba de diagn√≥stico del sistema',
                    datos_formulario: { test: true, timestamp: new Date().toISOString() },
                    nombre_padre_acudiente: 'Padre Prueba',
                    telefono_contacto: '1234567890',
                    email_contacto: 'prueba@diagnostico.com'
                };

                const { data, error } = await supabaseClient
                    .from('solicitudes')
                    .insert([testData])
                    .select();

                if (error) {
                    throw new Error(`Error en inserci√≥n: ${error.message}`);
                }

                addTestResult(`‚úÖ Inserci√≥n exitosa - ID: ${data[0].id}`, 'success');
                console.log('Datos insertados:', data[0]);

                // Limpiar datos de prueba
                await supabaseClient
                    .from('solicitudes')
                    .delete()
                    .eq('id', data[0].id);
                
                addTestResult('‚úÖ Datos de prueba limpiados', 'success');

            } catch (error) {
                addTestResult(`‚ùå Error en inserci√≥n: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        }

        async function testFormulario() {
            try {
                const form = document.getElementById('test-form');
                const formData = new FormData(form);
                
                const solicitudData = {
                    nombre_estudiante: document.getElementById('test-nombre').value,
                    grado: document.getElementById('test-grado').value,
                    motivo: document.getElementById('test-motivo').value,
                    nombre_padre_acudiente: document.getElementById('test-acudiente').value,
                    telefono_contacto: document.getElementById('test-telefono').value,
                    email_contacto: document.getElementById('test-email').value
                };

                addTestResult('üîÑ Procesando formulario de prueba...', 'info');
                console.log('Datos del formulario:', solicitudData);

                if (!solicitudData.nombre_estudiante || !solicitudData.grado || !solicitudData.motivo) {
                    throw new Error('Campos obligatorios faltantes');
                }

                addTestResult('‚úÖ Validaci√≥n de formulario exitosa', 'success');
                addTestResult('üí° Datos listos para env√≠o a Supabase', 'info');

            } catch (error) {
                addTestResult(`‚ùå Error en formulario: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('test-results').innerHTML = '<div class="log-entry log-info">Logs limpiados...</div>';
            document.getElementById('console-output').textContent = 'Logs limpiados...\n';
        }

        // Event listeners
        document.getElementById('test-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                addTestResult('üöÄ Enviando solicitud real...', 'info');
                
                if (!supabaseClient) {
                    const initialized = await initSupabase();
                    if (!initialized) return;
                }

                // Obtener IDs necesarios
                const { data: tipoData } = await supabaseClient
                    .from('tipos_solicitud')
                    .select('id')
                    .eq('nombre', 'excusa')
                    .single();

                const { data: estadoData } = await supabaseClient
                    .from('estados_solicitud')
                    .select('id')
                    .eq('nombre', 'pendiente')
                    .single();

                const { data: gradoData } = await supabaseClient
                    .from('grados')
                    .select('id')
                    .eq('nombre', document.getElementById('test-grado').value)
                    .single();

                const solicitudData = {
                    tipo_solicitud_id: tipoData.id,
                    estado_actual_id: estadoData.id,
                    nombre_estudiante: document.getElementById('test-nombre').value,
                    grado_id: gradoData.id,
                    motivo: document.getElementById('test-motivo').value,
                    datos_formulario: {
                        test: true,
                        timestamp: new Date().toISOString(),
                        source: 'diagnostic_form'
                    },
                    nombre_padre_acudiente: document.getElementById('test-acudiente').value,
                    telefono_contacto: document.getElementById('test-telefono').value,
                    email_contacto: document.getElementById('test-email').value
                };

                const { data, error } = await supabaseClient
                    .from('solicitudes')
                    .insert([solicitudData])
                    .select();

                if (error) {
                    throw new Error(error.message);
                }

                addTestResult(`üéâ ¬°SOLICITUD CREADA EXITOSAMENTE! Radicado: ${data[0].radicado}`, 'success');
                updateMainStatus('‚úÖ Sistema funcionando correctamente', 'success');
                console.log('Solicitud creada:', data[0]);

                // Limpiar formulario
                document.getElementById('test-form').reset();
                document.getElementById('test-nombre').value = 'Estudiante Prueba';
                document.getElementById('test-acudiente').value = 'Acudiente Prueba';
                document.getElementById('test-email').value = 'prueba@test.com';
                document.getElementById('test-telefono').value = '1234567890';
                document.getElementById('test-motivo').value = 'Prueba de funcionamiento del sistema';

            } catch (error) {
                addTestResult(`‚ùå Error enviando solicitud: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        });

        // Inicializaci√≥n autom√°tica
        document.addEventListener('DOMContentLoaded', async () => {
            addTestResult('üîÑ Iniciando diagn√≥stico autom√°tico...', 'info');
            
            setTimeout(async () => {
                await testSupabaseConnection();
                await testDatabaseStructure();
                
                updateMainStatus('‚úÖ Diagn√≥stico completado - Sistema listo para pruebas', 'success');
                addTestResult('üéØ Diagn√≥stico autom√°tico completado. Use los botones para pruebas manuales.', 'success');
            }, 1000);
        });
    </script>
</body>
</html>
